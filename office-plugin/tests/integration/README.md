# Office 插件真实集成测试

这些测试通过HTTP调用真实的主应用AI服务(localhost:3001),验证完整的工具调用流程。

## 前提条件

**重要**: 这些测试需要主应用正在运行并监听在 `localhost:3001`

### 启动主应用
1. 在项目根目录运行主应用:
   ```bash
   yarn dev
   ```

2. 确保主应用API服务器已启动
   - 检查控制台输出,确认API服务器运行在 `http://localhost:3001`
   - 或访问 `http://localhost:3001/health` 检查健康状态

## 运行测试

### 运行所有集成测试
```bash
cd packages/office-plugin
yarn vitest tests/integration/
```

### 运行单个测试文件
```bash
# Word 功能测试
yarn vitest tests/integration/word-真实集成测试.ts

# Excel 功能测试
yarn vitest tests/integration/excel-真实集成测试.ts

# PowerPoint 功能测试
yarn vitest tests/integration/powerpoint-真实集成测试.ts
```

## 测试架构

### Word 功能测试 (示例测试点)
- 文本编辑功能
  - 查找替换
  - 插入批注
  - 插入符号
- 文本格式化
  - 字体格式化
  - 段落格式化
- 图片功能
  - 调整图片尺寸
  - 图片对齐

### Excel 功能测试 (8个功能点)
- 公式生成
- 公式解释
- 数据透视表
- 图表创建
- 数据分析
- 区域格式化

### PowerPoint 功能测试 (4个功能点)
- 更新幻灯片内容
- 添加幻灯片
- 删除幻灯片
- 文本格式化

## 测试验证点

每个测试都验证以下内容:

1. **AI理解能力**: AI是否正确理解了用户的自然语言请求
2. **工具选择**: AI是否选择了正确的工具函数
3. **参数生成**: AI生成的工具参数是否正确
4. **响应时间**: 记录每个测试的执行时间

## 测试报告

测试完成后会在控制台输出详细的JSON报告:

```json
{
  "测试类型": "真实AI集成测试",
  "AI服务": "localhost:3001",
  "总测试数": 10,
  "成功数": 9,
  "失败数": 1,
  "成功率": "90.00%",
  "平均响应时间": "1250ms",
  "详细结果": [...]
}
```

## 故障排除

### 测试失败: "主应用API服务器未运行"
- 确保主应用已启动并运行在 `localhost:3001`
- 检查主应用的启动日志
- 尝试访问 `http://localhost:3001/health`

### 测试超时
- 默认超时时间为35秒
- 如果AI响应较慢,测试可能超时
- 可以在测试文件中调整timeout参数

### AI未调用正确的工具
- 检查工具Schema是否正确注册
- 查看AI的textResponse,了解AI的理解
- 可能需要优化用户消息的表述

## 与自动化测试的区别

| 特性 | 真实集成测试 | 自动化测试 |
|------|------------|----------|
| AI调用 | 真实HTTP调用 | Mock模拟 |
| 依赖 | 需要主应用运行 | 无外部依赖 |
| 测试目标 | 端到端流程 | Schema验证 |
| 运行速度 | 较慢(~1-2s/测试) | 很快(~10ms/测试) |
| AI理解验证 | ✅ 是 | ❌ 否 |

## 最佳实践

1. **定期运行**: 在每次发布前运行完整的集成测试
2. **测试隔离**: 每个测试应独立,不依赖其他测试的状态
3. **错误处理**: 测试应优雅处理AI响应异常
4. **报告分析**: 仔细分析失败测试的AI响应,优化提示词